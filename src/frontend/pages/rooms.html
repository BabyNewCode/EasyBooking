<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chambres - EasyBooking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .room-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }
    
    .room-box {
      background: white;
      border: 3px solid #ddd;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .room-box:hover {
      transform: translateY(-10px);
      border-color: #9B59B6;
      box-shadow: 0 8px 24px rgba(155,89,182,0.3);
    }
    
    .room-name {
      font-size: 2em;
      font-weight: bold;
      color: #9B59B6;
      margin: 15px 0;
    }
    
    .capacity-badge {
      display: inline-block;
      background-color: #9B59B6;
      color: white;
      padding: 8px 16px;
      border-radius: 25px;
      font-weight: bold;
      margin: 15px 0;
    }
    
    .reserve-btn {
      background-color: #9B59B6;
      border-color: #9B59B6;
      color: white;
      margin-top: 20px;
      padding: 10px 20px;
      font-weight: bold;
    }
    
    .reserve-btn:hover {
      background-color: #7d3e8f;
      border-color: #7d3e8f;
      color: white;
    }

    .floor-section {
      margin-top: 50px;
      margin-bottom: 50px;
    }

    .floor-title {
      font-size: 2em;
      color: #9B59B6;
      font-weight: bold;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 3px solid #9B59B6;
    }
  </style>
</head>
<body>
  <!-- Navbar will be injected by navbar.js -->

  <!-- Hero Section -->
  <div class="hero">
    <div class="container-fluid">
      <h1>R√©servez Votre Chambre</h1>
      <p>S√©lectionnez une chambre pour voir les disponibilit√©s</p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-fluid p-5">
    <div id="alertContainer"></div>
    <div id="roomsContainer" class="loading">Chargement des chambres...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/navbar.js"></script>
  <script>
    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      container.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    async function loadRooms() {
      try {
        console.log('üìç Chargement des chambres...');
        const response = await APIClient.get('/rooms');
        
        if (!response.ok) {
          showAlert('Erreur: impossible de charger les chambres', 'danger');
          return;
        }

        const rooms = await response.json();
        console.log('‚úÖ Chambres re√ßues:', rooms);

        if (!Array.isArray(rooms) || rooms.length === 0) {
          document.getElementById('roomsContainer').innerHTML = '<div class="alert alert-warning">Aucune chambre disponible</div>';
          return;
        }

        // Group rooms by floor
        const byFloor = {};
        rooms.forEach(room => {
          if (!byFloor[room.floor]) byFloor[room.floor] = [];
          byFloor[room.floor].push(room);
        });

        // Generate HTML for each floor
        let html = '';
        [1, 2, 3].forEach(floor => {
          if (byFloor[floor]) {
            html += `
              <div class="floor-section">
                <h2 class="floor-title">√âtage ${floor} - ${floor === 1 ? 'Chambres 1 personne' : floor === 2 ? 'Chambres 2 personnes' : 'Chambres 4 personnes'}</h2>
                <div class="room-grid">
            `;
            
            byFloor[floor].forEach(room => {
              html += `
                <div class="room-box" onclick="selectRoom('${room._id}', '${room.name}', ${room.capacity})">
                  <div class="room-name">${room.name}</div>
                  <div class="capacity-badge">Capacit√©: ${room.capacity} personne${room.capacity > 1 ? 's' : ''}</div>
                  <button type="button" class="btn reserve-btn">R√©server cette chambre</button>
                </div>
              `;
            });
            
            html += `
                </div>
              </div>
            `;
          }
        });

        document.getElementById('roomsContainer').innerHTML = html;
      } catch (error) {
        console.error('‚ùå Erreur:', error);
        showAlert('Erreur lors du chargement des chambres', 'danger');
      }
    }

    function selectRoom(roomId, roomName, capacity) {
      // Check if user is logged in
      if (!localStorage.getItem('token')) {
        showAlert('Veuillez vous connecter pour r√©server', 'warning');
        setTimeout(() => {
          window.location.href = '/login';
        }, 1500);
        return;
      }

      // Prompt for reservation details
      const startDate = prompt(`R√©server: ${roomName}\n\nCapacit√©: ${capacity} personne${capacity > 1 ? 's' : ''}\n\nDate d'arriv√©e (YYYY-MM-DD):`);
      if (!startDate) return;

      const endDate = prompt('Date de d√©part (YYYY-MM-DD):');
      if (!endDate) return;

      const numGuests = prompt(`Nombre d'invit√©s (max ${capacity}):`, '1');
      if (!numGuests) return;

      const guestCount = parseInt(numGuests);
      if (isNaN(guestCount) || guestCount < 1 || guestCount > capacity) {
        showAlert(`Le nombre d'invit√©s doit √™tre entre 1 et ${capacity}`, 'danger');
        return;
      }

      // Create reservation
      createReservationRequest(roomId, startDate, endDate, guestCount);
    }

    async function createReservationRequest(roomId, startDate, endDate, numGuests) {
      try {
        const startDateTime = new Date(`${startDate}T14:00:00`).toISOString();
        const endDateTime = new Date(`${endDate}T10:00:00`).toISOString();

        const response = await APIClient.post('/reservations', {
          roomId: roomId,
          startTime: startDateTime,
          endTime: endDateTime,
          numberOfGuests: numGuests,
          notes: ''
        });

        if (response.ok) {
          const data = await response.json();
          showAlert('‚úÖ R√©servation confirm√©e!', 'success');
          setTimeout(() => {
            window.location.href = '/reservations';
          }, 1500);
        } else {
          const error = await response.json();
          showAlert(`Erreur: ${error.message || 'Impossible de cr√©er la r√©servation'}`, 'danger');
        }
      } catch (error) {
        console.error('Erreur lors de la cr√©ation:', error);
        showAlert('Erreur lors de la cr√©ation de la r√©servation', 'danger');
      }
    }

    // Load rooms on page load
    document.addEventListener('DOMContentLoaded', loadRooms);
  </script>
</body>
</html>
